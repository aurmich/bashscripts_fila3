<?php

declare(strict_types=1);

namespace Modules\IndennitaCondizioniLavoro\Filament\Resources;

// use Filament\Forms;
use Filament\Forms\Components\DatePicker;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\TextInput;
use Filament\Resources\Resource;
use Filament\Tables;
use Filament\Tables\Actions\DeleteBulkAction;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Table;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\Model;
use Modules\IndennitaCondizioniLavoro\Filament\Resources\CondizioniLavoroResource\Pages\CompilaCondizioniLavoro;
use Modules\IndennitaCondizioniLavoro\Filament\Resources\CondizioniLavoroResource\Pages\CreateCondizioniLavoro;
use Modules\IndennitaCondizioniLavoro\Filament\Resources\CondizioniLavoroResource\Pages\EditCondizioniLavoro;
// use Illuminate\Database\Eloquent\SoftDeletingScope;
use Modules\IndennitaCondizioniLavoro\Filament\Resources\CondizioniLavoroResource\Pages\ListCondizioniLavoros;
use Modules\IndennitaCondizioniLavoro\Filament\Resources\CondizioniLavoroResource\Widgets\CondizioniLavoroOverview;
use Modules\IndennitaCondizioniLavoro\Models\CondizioniLavoro;

class CondizioniLavoroResource extends Resource
{
    protected static ?string $model = CondizioniLavoro::class;

    protected static ?string $navigationIcon = 'heroicon-o-rectangle-stack';

    // protected static ?string $recordTitleAttribute = 'name';
    public static ?string $label = 'Condizioni Lavoro/Servizio Esterno ';

    public static function getFormSchema(): array
    {
        return [
            TextInput::make('matr'),
            TextInput::make('cognome'),
            TextInput::make('nome'),
            TextInput::make('stabi'),
            TextInput::make('repar'),
            DatePicker::make('dal'),
            DatePicker::make('al'),
            TextInput::make('anno'),
            Select::make('valutatore_id')
                ->options(fn ($record) => app(\Modules\Ptv\Actions\GetAllValutatoriOptions::class)->execute('IndennitaCondizioniLavoro', $record->anno)),
            Select::make('indennitaTipoDettaglio')
                ->multiple()
                ->relationship('indennitaTipoDettaglio', 'nome',
                    fn (Builder $query, Model $record) => $query->where('dal', '<=', $record->anno)->where('al', '>=', $record->anno)
                )
                ->getOptionLabelFromRecordUsing(fn (Model $record): string => sprintf(' %s] %s %s %s', $record->indennitaTipo?->nome, $record->nome, $record->dal, $record->al)),
        ];
    }

    public static function tableIII(Table $table): Table
    {
        return $table
            ->columns([
                TextColumn::make('matr')->searchable(),
                TextColumn::make('cognome')->searchable(),
                TextColumn::make('nome')->searchable(),
                TextColumn::make('stabi')->searchable(),
                TextColumn::make('repar')->searchable(),
                // TextColumn::make('indennitaTipo.nome'), //fare relazione
                TextColumn::make('indennitaTipoDettaglio')
                    ->formatStateUsing(function (TextColumn $column) {
                        $state = $column->getState();

                        return $state->pluck('indennitaTipo.nome')->implode(','.PHP_EOL.PHP_EOL.'');
                    })
                    ->wrap()
                    ->tooltip(function (TextColumn $column): ?string {
                        $state = $column->getState();

                        return $state?->map(fn ($item): string => '['.$item->indennitaTipo?->nome.'] '.$item->nome)->implode(' --------------------- ,'.PHP_EOL.PHP_EOL.'');
                    }),

                /*
                // ->relationship('indennitaTipoDettaglio', 'nome')

                TextColumn::make('tot')->sortable()->searchable(),
                */
                // Tables\Columns\TextColumn::make('dal')->date('d/m/Y'),
                // Tables\Columns\TextColumn::make('al')->date('d/m/Y'),
                TextColumn::make('quadrimestre')->searchable(),
                TextColumn::make('anno')->searchable(),
            ])
            /*
            ->actions([
                // Tables\Actions\ViewAction::make(),

                Tables\Actions\Action::make('compila')
                     ->label('Compila')
                     ->icon('heroicon-s-pencil-alt')
                     ->url(fn ($record): string => self::getUrl('compila', ['record' => $record])),

                Tables\Actions\EditAction::make(),
                // Tables\Actions\EditAction::make(),
            ])
            */
            ->bulkActions([
                DeleteBulkAction::make(),
            ]);
    }

    public static function getRelations(): array
    {
        return [
        ];
    }

    public static function getWidgets(): array
    {
        return [
            CondizioniLavoroOverview::class,
        ];
    }

    public static function getPages(): array
    {
        return [
            'index' => ListCondizioniLavoros::route('/'),
            'create' => CreateCondizioniLavoro::route('/create'),
            'edit' => EditCondizioniLavoro::route('/{record}/edit'),
            'compila' => CompilaCondizioniLavoro::route('/{record}/compila'),
        ];
    }

   
}
